<div class="referals-section">
    <div class="section-header">
        <div class="section-title">
            <h3><i class="fas fa-users"></i> Мои рефералы</h3>
            <p class="section-subtitle">Список всех ваших рефералов и их статусы</p>
        </div>
        <div class="section-actions">
            {% if current_sort %}
            <a href="{{ url_for('referal.profile', **current_filters) }}" class="reset-sort-btn" title="Сбросить сортировку">
                <i class="fas fa-undo"></i> Сбросить сортировку
            </a>
            {% endif %}
            <button type="button" class="add-referal-btn open_document_form" data-referal-id="new">
                <i class="fas fa-plus"></i>
                Добавить реферала
            </button>
        </div>
        {% include 'modals/add_referal_form.html' %}
    </div>
    
    {% if total_user_referals > 0 %}
    <div class="table-container">
        <table class="referals-table">
            <thead>
                <tr>
                    <th>
                        <div class="header-cell">
                            <div class="header-title">
                                <span>ФИО</span>
                                <div class="sort-controls">
                                    {% for sort_field in sort_fields %}
                                        {% if sort_field.field == 'name' %}
                                    <button type="button" class="clear-sort-btn" data-field="name" title="Убрать из сортировки">
                                        <i class="fas fa-times cancel_sort"></i>
                                    </button>
                                    <span class="sort-number">{{ loop.index }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <button type="button" class="sort-btn" data-field="name" title="Изменить сортировку">
                                        {% if sort_fields|selectattr('field', 'equalto', 'name')|list %}
                                            {% set name_field = sort_fields|selectattr('field', 'equalto', 'name')|first %}
                                            <i class="fas fa-caret-{{ 'up' if name_field.order == 'asc' else 'down' }}"></i>
                                        {% else %}
                                            <i class="fas fa-sort"></i>
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                            <div class="header-controls">
                                <input type="text" 
                                       class="header-filter" 
                                       placeholder="Поиск по ФИО"
                                       value="{{ current_filters.name }}"
                                       data-filter="name">
                                {% if current_filters.name %}
                                <button type="button" class="clear-filter-btn" data-filter="name" title="Очистить фильтр">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </th>
                    <th >
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Телефон</span>
                                <div class="sort-controls">
                                    {% for sort_field in sort_fields %}
                                        {% if sort_field.field == 'phone' %}
                                    <button type="button" class="clear-sort-btn" data-field="phone" title="Убрать из сортировки">
                                        <i class="fas fa-times cancel_sort"></i>
                                    </button>
                                    <span class="sort-number">{{ loop.index }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <button type="button" class="sort-btn" data-field="phone" title="Изменить сортировку">
                                        {% if sort_fields|selectattr('field', 'equalto', 'phone')|list %}
                                            {% set phone_field = sort_fields|selectattr('field', 'equalto', 'phone')|first %}
                                            <i class="fas fa-caret-{{ 'up' if phone_field.order == 'asc' else 'down' }}"></i>
                                        {% else %}
                                            <i class="fas fa-sort"></i>
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                            <div class="header-controls">
                                <input type="text" 
                                       class="header-filter" 
                                       placeholder="Поиск по телефону"
                                       value="{{ current_filters.phone }}"
                                       data-filter="phone">
                                {% if current_filters.phone %}
                                <button type="button" class="clear-filter-btn" data-filter="phone" title="Очистить фильтр">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </th>
                    <th >
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Договор</span>
                                <div class="sort-controls">
                                    {% for sort_field in sort_fields %}
                                        {% if sort_field.field == 'contract' %}
                                    <button type="button" class="clear-sort-btn" data-field="contract" title="Убрать из сортировки">
                                        <i class="fas fa-times cancel_sort"></i>
                                    </button>
                                    <span class="sort-number">{{ loop.index }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <button type="button" class="sort-btn" data-field="contract" title="Изменить сортировку">
                                        {% if sort_fields|selectattr('field', 'equalto', 'contract')|list %}
                                            {% set contract_field = sort_fields|selectattr('field', 'equalto', 'contract')|first %}
                                            <i class="fas fa-caret-{{ 'up' if contract_field.order == 'asc' else 'down' }}"></i>
                                        {% else %}
                                            <i class="fas fa-sort"></i>
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                            <div class="header-controls">
                                <input type="text" 
                                       class="header-filter" 
                                       placeholder="Номер договора"
                                       value="{{ current_filters.contract }}"
                                       data-filter="contract">
                                {% if current_filters.contract %}
                                <button type="button" class="clear-filter-btn" data-filter="contract" title="Очистить фильтр">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </th>
                    <th >
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Macro ID</span>
                            </div>
                            <div class="header-controls">
                                <input type="text" 
                                       class="header-filter" 
                                       placeholder="Macro ID"
                                       value="{{ current_filters.contact_id }}"
                                       data-filter="contact_id">
                                {% if current_filters.contact_id %}
                                <button type="button" class="clear-filter-btn" data-filter="contact_id" title="Очистить фильтр">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </th>
                    <th >
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Статус</span>
                                <div class="sort-controls">
                                    {% for sort_field in sort_fields %}
                                        {% if sort_field.field == 'status' %}
                                    <button type="button" class="clear-sort-btn" data-field="status" title="Убрать из сортировки">
                                        <i class="fas fa-times cancel_sort"></i>
                                    </button>
                                    <span class="sort-number">{{ loop.index }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <button type="button" class="sort-btn" data-field="status" title="Изменить сортировку">
                                        {% if sort_fields|selectattr('field', 'equalto', 'status')|list %}
                                            {% set status_field = sort_fields|selectattr('field', 'equalto', 'status')|first %}
                                            <i class="fas fa-caret-{{ 'up' if status_field.order == 'asc' else 'down' }}"></i>
                                        {% else %}
                                            <i class="fas fa-sort"></i>
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                            <div class="header-controls">
                                <div class="multiselect-filter" id="status-filter-container">
                                    <button type="button" class="multiselect-btn" id="status-filter-btn">
                                        <span>Статусы</span> <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <div class="multiselect-dropdown" id="status-filter-dropdown">
                                        <div class="multiselect-options">
                                            <div class="multiselect-actions">
                                            <button class="action-btn apply-btn" id='all_btn'>Выбрать все</button>
                                            <button class="action-btn apply-btn" id='clear_btn'>Очистить</button>
                                            </div>
                                            {% for status in statuses %}
                                                <label>
                                                <div class="multiselect-option">
                                                    <input type="checkbox" name="status" value="{{ status.id }}" 
                                                           {% if status.id in selected_statuses %}checked{% endif %}>
                                                            <span>{{ status.name }}</span>
                                                        </input>
                                                </div></label>
                                            {% endfor %}
                                        </div>
                                        <div class="multiselect-actions">
                                            <button type="button" class="action-btn apply-btn" id="apply-status-filter">Применить</button>
                                            <button type="button" class="action-btn default-btn" id="default-status-filter">По умолчанию</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </th>
                    <th >
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Сумма к выводу</span>
                                <div class="sort-controls">
                                    {% for sort_field in sort_fields %}
                                        {% if sort_field.field == 'amount' %}
                                    <button type="button" class="clear-sort-btn" data-field="amount" title="Убрать из сортировки">
                                        <i class="fas fa-times cancel_sort"></i>
                                    </button>
                                    <span class="sort-number">{{ loop.index }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <button type="button" class="sort-btn" data-field="amount" title="Изменить сортировку">
                                        {% if sort_fields|selectattr('field', 'equalto', 'amount')|list %}
                                            {% set amount_field = sort_fields|selectattr('field', 'equalto', 'amount')|first %}
                                            <i class="fas fa-caret-{{ 'up' if amount_field.order == 'asc' else 'down' }}"></i>
                                        {% else %}
                                            <i class="fas fa-sort"></i>
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </th>
                    <th >
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Действия</span>
                            </div>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% if referals %}
                    {% for referal in referals %}
                        {% include 'components/referal_table_row.html' %}
                        {% include 'modals/rejection_reason_modal.html' %}
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" class="no-results">
                            <div class="no-results-content">
                                <i class="fas fa-search"></i>
                                <h4>По заданным фильтрам ничего не найдено</h4>
                                <p>Попробуйте изменить параметры поиска</p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- Пагинация под таблицей - показывается всегда -->
    {% include 'components/pagination.html' %}
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-users"></i>
        </div>
        <h4>У вас пока нет рефералов</h4>
        <p>Добавьте первого реферала, нажав кнопку "Добавить реферала"</p>
    </div>
    
    <!-- Пагинация показывается даже при отсутствии рефералов -->
    {% include 'components/pagination.html' %}
    {% endif %}
</div>
<script>
    // static/js/components/multiselect-filter.js

document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('status-filter-container');
    if (!container) return;

    const btn = document.getElementById('status-filter-btn');
    const dropdown = document.getElementById('status-filter-dropdown');
    const applyBtn = document.getElementById('apply-status-filter');
    const clearBtn = document.getElementById('clear-status-filter');
    const defaultBtn = document.getElementById('default-status-filter');
    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
    const all_btn = document.getElementById('all_btn');
    const clear_btn = document.getElementById('clear_btn');

    all_btn.addEventListener('click', (e) => {
      // e.target — это элемент, по которому кликнули (в нашем случае all_checkbox)
      // e.target.checked — это его состояние (true, если выбран, false — если нет)
      // Перебираем все чекбоксы в списке checkboxes
      checkboxes.forEach(checkbox => {
        // Каждому чекбоксу присваиваем то же состояние, что и у главного
        checkbox.checked = true;
      });
    });

    clear_btn.addEventListener('click', (e) => {
      // e.target — это элемент, по которому кликнули (в нашем случае all_checkbox)
      // e.target.checked — это его состояние (true, если выбран, false — если нет)
      // Перебираем все чекбоксы в списке checkboxes
      checkboxes.forEach(checkbox => {
        // Каждому чекбоксу присваиваем то же состояние, что и у главного
        checkbox.checked = false;
      });
    });
    // Функция для обновления текста на кнопке
    const updateButtonText = () => {
        const checkedCount = dropdown.querySelectorAll('input[type="checkbox"]:checked').length;
        const btnText = btn.querySelector('span');
        if (checkedCount > 0) {
            btnText.textContent = `Статусы (выбрано ${checkedCount})`;
        } else {
            btnText.textContent = 'Статусы';
        }
    };

    // Открытие/закрытие выпадающего списка
    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('active');
    });

    // Закрытие по клику вне элемента
    document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
            dropdown.classList.remove('active');
        }
    });
    
    // Не закрывать меню при клике внутри него
    dropdown.addEventListener('click', (e) => e.stopPropagation());

    // Кнопка "Применить"
    applyBtn.addEventListener('click', () => {
        const selectedStatuses = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        const currentUrl = new URL(window.location);
        const params = currentUrl.searchParams;

        if (selectedStatuses.length > 0) {
            params.set('status', selectedStatuses.join(','));
        } else {
            params.delete('status'); // Если ничего не выбрано, убираем параметр
        }
        
        params.set('page', '1'); // Сбрасываем на первую страницу при смене фильтра
        window.location.search = params.toString();
    });
    
    // Кнопка "Все доступные" (сбрасывает URL к состоянию по умолчанию)
    defaultBtn.addEventListener('click', () => {
        const currentUrl = new URL(window.location);
        const params = currentUrl.searchParams;
        
        // Эта кнопка приводит фильтр статусов в стандартное значение, удаляя параметр 'status'
        params.delete('status');
        params.set('page', '1');
        
        window.location.search = params.toString();
    });
    
    // Инициализация текста кнопки при загрузке страницы
    updateButtonText();
});
</script>