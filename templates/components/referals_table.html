<div class="referals-section">
    <div class="section-header">
        <div class="section-title">
            <h3><i class="fas fa-users"></i> Мои рефералы</h3>
            <p class="section-subtitle">Список всех ваших рефералов и их статусы</p>
        </div>
        <div class="section-actions">
            {% if current_sort %}
            <a href="{{ url_for('referal.profile', **current_filters) }}" class="reset-sort-btn" title="Сбросить сортировку">
                <i class="fas fa-undo"></i> Сбросить сортировку
            </a>
            {% endif %}
            <button type="button" class="add-referal-btn open_document_form" data-referal-id="new">
                <i class="fas fa-plus"></i>
                Добавить реферала
            </button>
        </div>
        {% include 'components/add_referal_form.html' %}
    </div>
    
    {% if total_user_referals > 0 %}
    <div class="table-container">
        <table class="referals-table">
            <thead>
                <tr>
                    <th style="width: 15%;">
                        <div class="header-cell">
                            <div class="header-title">
                                <span>ФИО</span>
                                <div class="sort-controls">
                                    {% for sort_field in sort_fields %}
                                        {% if sort_field.field == 'name' %}
                                    <button type="button" class="clear-sort-btn" data-field="name" title="Убрать из сортировки">
                                        <i class="fas fa-times cancel_sort"></i>
                                    </button>
                                    <span class="sort-number">{{ loop.index }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <button type="button" class="sort-btn" data-field="name" title="Изменить сортировку">
                                        {% if sort_fields|selectattr('field', 'equalto', 'name')|list %}
                                            {% set name_field = sort_fields|selectattr('field', 'equalto', 'name')|first %}
                                            <i class="fas fa-caret-{{ 'up' if name_field.order == 'asc' else 'down' }}"></i>
                                        {% else %}
                                            <i class="fas fa-sort"></i>
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                            <div class="header-controls">
                                <input type="text" 
                                       class="header-filter" 
                                       placeholder="Поиск по ФИО"
                                       value="{{ current_filters.name }}"
                                       data-filter="name">
                                {% if current_filters.name %}
                                <button type="button" class="clear-filter-btn" data-filter="name" title="Очистить фильтр">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </th>
                    <th style="width: 12%;">
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Телефон</span>
                                <div class="sort-controls">
                                    {% for sort_field in sort_fields %}
                                        {% if sort_field.field == 'phone' %}
                                    <button type="button" class="clear-sort-btn" data-field="phone" title="Убрать из сортировки">
                                        <i class="fas fa-times cancel_sort"></i>
                                    </button>
                                    <span class="sort-number">{{ loop.index }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <button type="button" class="sort-btn" data-field="phone" title="Изменить сортировку">
                                        {% if sort_fields|selectattr('field', 'equalto', 'phone')|list %}
                                            {% set phone_field = sort_fields|selectattr('field', 'equalto', 'phone')|first %}
                                            <i class="fas fa-caret-{{ 'up' if phone_field.order == 'asc' else 'down' }}"></i>
                                        {% else %}
                                            <i class="fas fa-sort"></i>
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                            <div class="header-controls">
                                <input type="text" 
                                       class="header-filter" 
                                       placeholder="Поиск по телефону"
                                       value="{{ current_filters.phone }}"
                                       data-filter="phone">
                                {% if current_filters.phone %}
                                <button type="button" class="clear-filter-btn" data-filter="phone" title="Очистить фильтр">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </th>
                    <th style="width: 12%;">
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Договор</span>
                                <div class="sort-controls">
                                    {% for sort_field in sort_fields %}
                                        {% if sort_field.field == 'contract' %}
                                    <button type="button" class="clear-sort-btn" data-field="contract" title="Убрать из сортировки">
                                        <i class="fas fa-times cancel_sort"></i>
                                    </button>
                                    <span class="sort-number">{{ loop.index }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <button type="button" class="sort-btn" data-field="contract" title="Изменить сортировку">
                                        {% if sort_fields|selectattr('field', 'equalto', 'contract')|list %}
                                            {% set contract_field = sort_fields|selectattr('field', 'equalto', 'contract')|first %}
                                            <i class="fas fa-caret-{{ 'up' if contract_field.order == 'asc' else 'down' }}"></i>
                                        {% else %}
                                            <i class="fas fa-sort"></i>
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                            <div class="header-controls">
                                <input type="text" 
                                       class="header-filter" 
                                       placeholder="Номер договора"
                                       value="{{ current_filters.contract }}"
                                       data-filter="contract">
                                {% if current_filters.contract %}
                                <button type="button" class="clear-filter-btn" data-filter="contract" title="Очистить фильтр">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </th>
                    <th style="width: 8%;">
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Macro ID</span>
                            </div>
                            <div class="header-controls">
                                <input type="text" 
                                       class="header-filter" 
                                       placeholder="Macro ID"
                                       value="{{ current_filters.contact_id }}"
                                       data-filter="contact_id">
                                {% if current_filters.contact_id %}
                                <button type="button" class="clear-filter-btn" data-filter="contact_id" title="Очистить фильтр">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </th>
                    <th style="width: 10%;">
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Статус</span>
                                <div class="sort-controls">
                                    {% for sort_field in sort_fields %}
                                        {% if sort_field.field == 'status' %}
                                    <button type="button" class="clear-sort-btn" data-field="status" title="Убрать из сортировки">
                                        <i class="fas fa-times cancel_sort"></i>
                                    </button>
                                    <span class="sort-number">{{ loop.index }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <button type="button" class="sort-btn" data-field="status" title="Изменить сортировку">
                                        {% if sort_fields|selectattr('field', 'equalto', 'status')|list %}
                                            {% set status_field = sort_fields|selectattr('field', 'equalto', 'status')|first %}
                                            <i class="fas fa-caret-{{ 'up' if status_field.order == 'asc' else 'down' }}"></i>
                                        {% else %}
                                            <i class="fas fa-sort"></i>
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                            <div class="header-controls">
                                <select class="header-filter header-select" data-filter="status">
                                    <option value="">Все</option>
                                    <option value="no_status" {{ 'selected' if current_filters.status == 'no_status' else '' }}>Не начата</option>
                                    {% for status in statuses %}
                                        {% if status.id != 0 %}
                                        <option value="{{ status.id }}" {{ 'selected' if current_filters.status == status.id|string else '' }}>
                                            {{ status.name }}
                                        </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                {% if current_filters.status %}
                                <button type="button" class="clear-filter-btn" data-filter="status" title="Очистить фильтр">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </th>
                    <th style="width: 10%;">
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Сумма к выводу</span>
                                <div class="sort-controls">
                                    {% for sort_field in sort_fields %}
                                        {% if sort_field.field == 'amount' %}
                                    <button type="button" class="clear-sort-btn" data-field="amount" title="Убрать из сортировки">
                                        <i class="fas fa-times cancel_sort"></i>
                                    </button>
                                    <span class="sort-number">{{ loop.index }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <button type="button" class="sort-btn" data-field="amount" title="Изменить сортировку">
                                        {% if sort_fields|selectattr('field', 'equalto', 'amount')|list %}
                                            {% set amount_field = sort_fields|selectattr('field', 'equalto', 'amount')|first %}
                                            <i class="fas fa-caret-{{ 'up' if amount_field.order == 'asc' else 'down' }}"></i>
                                        {% else %}
                                            <i class="fas fa-sort"></i>
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </th>
                    <th style="width: 12%;">
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Вывод средств</span>
                            </div>
                        </div>
                    </th>
                    <th style="width: 11%;">
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Документы</span>
                            </div>
                        </div>
                    </th>
                    <th style="width: 10%;">
                        <div class="header-cell">
                            <div class="header-title">
                                <span>Скачать акт</span>
                            </div>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% if referals %}
                    {% for referal in referals %}
                        {% include 'components/referal_table_row.html' %}
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" class="no-results">
                            <div class="no-results-content">
                                <i class="fas fa-search"></i>
                                <h4>По заданным фильтрам ничего не найдено</h4>
                                <p>Попробуйте изменить параметры поиска</p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- Пагинация под таблицей - показывается всегда -->
    {% include 'components/pagination.html' %}
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-users"></i>
        </div>
        <h4>У вас пока нет рефералов</h4>
        <p>Добавьте первого реферала, нажав кнопку "Добавить реферала"</p>
    </div>
    
    <!-- Пагинация показывается даже при отсутствии рефералов -->
    {% include 'components/pagination.html' %}
    <!-- Пагинация показывается даже при отсутствии рефералов -->
    {% include 'components/pagination.html' %}
    {% endif %}
</div>