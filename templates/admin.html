<!-- filepath: c:\Users\d.tolkunov\CodeRepository\AnalyticsRepo\referal\templates\admin.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление рефералами</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Сначала загружаем базовые стили с переменными -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    
    <!-- Inline критический JavaScript для предотвращения FOUC -->
    <script>
        (function() {
            function getCookie(name) {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            }
            
            const cookieTheme = getCookie('gh_theme');
            const savedTheme = cookieTheme || localStorage.getItem('gh_theme_preference') || 'light';
            
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark-theme');
            }
        })();
    </script>
    
    <!-- Подключение CSS файлов -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/tables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/modals.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/cards.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/inputs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/notifications.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/responsive.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/footer.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/filters.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/pagination.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/table-filters.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/validation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/macro-crm.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/add-referal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/referals.css') }}">

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<body>

    <div id="particles-js" class="bg-parts"></div>
    <div class="page-wrapper">
        {% include 'components/header.html' %}
        {% include 'components/flash_messages.html' %}
        
        <main class="main">
            <div class="container">
                <div class="admin-section">
                    <div class="section-header">
                        <div class="section-title">
                            {% if current_user.role == 'manager' %}
                            <h3>Управление выплатами</h3>
                            <p class="section-subtitle">Рефералы готовые к выплате</p>
                            {% elif current_user.role == 'call-center' %}
                            <h3>Проверка рефералов</h3>
                            <p class="section-subtitle">Рефералы готовые к проверке</p>
                            {% elif current_user.role == 'admin' %}
                            <h3>Управление рефералами</h3>
                            <p class="section-subtitle">Все рефералы в системе для модерации</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>ФИО</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'name' %}
                                                    <button type="button" class="clear-sort-btn" data-field="name" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="name" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'name')|list %}
                                                            {% set name_field = sort_fields|selectattr('field', 'equalto', 'name')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if name_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="header-controls">
                                                <input type="text" 
                                                       class="header-filter" 
                                                       placeholder="Поиск по ФИО"
                                                       value="{{ current_filters.name if current_filters else '' }}"
                                                       data-filter="name">
                                                {% if current_filters and current_filters.name %}
                                                <button type="button" class="clear-filter-btn" data-filter="name" title="Очистить фильтр">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Телефон</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'phone' %}
                                                    <button type="button" class="clear-sort-btn" data-field="phone" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="phone" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'phone')|list %}
                                                            {% set phone_field = sort_fields|selectattr('field', 'equalto', 'phone')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if phone_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="header-controls">
                                                <input type="text" 
                                                       class="header-filter" 
                                                       placeholder="Поиск по телефону"
                                                       value="{{ current_filters.phone if current_filters else '' }}"
                                                       data-filter="phone">
                                                {% if current_filters and current_filters.phone %}
                                                <button type="button" class="clear-filter-btn" data-filter="phone" title="Очистить фильтр">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Договор</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'contract' %}
                                                    <button type="button" class="clear-sort-btn" data-field="contract" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="contract" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'contract')|list %}
                                                            {% set contract_field = sort_fields|selectattr('field', 'equalto', 'contract')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if contract_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="header-controls">
                                                <input type="text" 
                                                       class="header-filter" 
                                                       placeholder="Номер договора"
                                                       value="{{ current_filters.contract if current_filters else '' }}"
                                                       data-filter="contract">
                                                {% if current_filters and current_filters.contract %}
                                                <button type="button" class="clear-filter-btn" data-filter="contract" title="Очистить фильтр">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </th>
                                    <th >
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Реферер</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'user' %}
                                                    <button type="button" class="clear-sort-btn" data-field="user" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="user" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'user')|list %}
                                                            {% set user_field = sort_fields|selectattr('field', 'equalto', 'user')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if user_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="header-controls">
                                                <input type="text" 
                                                       class="header-filter" 
                                                       placeholder="Пользователь"
                                                       value="{{ current_filters.user if current_filters else '' }}"
                                                       data-filter="user">
                                                {% if current_filters and current_filters.user %}
                                                <button type="button" class="clear-filter-btn" data-filter="user" title="Очистить фильтр">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Macro ID</span>
                                            </div>
                                            <div class="header-controls">
                                                <input type="text" 
                                                       class="header-filter" 
                                                       placeholder="Macro ID"
                                                       value="{{ current_filters.contact_id if current_filters else '' }}"
                                                       data-filter="contact_id">
                                                {% if current_filters and current_filters.contact_id %}
                                                <button type="button" class="clear-filter-btn" data-filter="contact_id" title="Очистить фильтр">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Статус</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'status' %}
                                                    <button type="button" class="clear-sort-btn" data-field="status" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="status" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'status')|list %}
                                                            {% set status_field = sort_fields|selectattr('field', 'equalto', 'status')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if status_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="header-controls">
                                                <div class="multiselect-filter" id="status-filter-container">
                                                    <button type="button" class="multiselect-btn" id="status-filter-btn">
                                                        <span>Статусы</span> <i class="fas fa-chevron-down"></i>
                                                    </button>
                                                    <div class="multiselect-dropdown" id="status-filter-dropdown">
                                                        <div class="multiselect-options">
                                                            <div class="multiselect-actions">
                                                            <button class="action-btn apply-btn" id='all_btn'>Выбрать все</button>
                                                            <button class="action-btn apply-btn" id='clear_btn'>Очистить</button>
                                                            </div>
                                                            {% for status in statuses %}
                                                                <label>
                                                                <div class="multiselect-option">
                                                                    <input type="checkbox" name="status" value="{{ status.id }}" 
                                                                           {% if status.id in selected_statuses %}checked{% endif %}>
                                                                            <span>{{ status.name }}</span>
                                                                        </input>
                                                                </div></label>
                                                            {% endfor %}
                                                        </div>
                                                        <div class="multiselect-actions">
                                                            <button type="button" class="action-btn apply-btn" id="apply-status-filter">Применить</button>
                                                            <button type="button" class="action-btn default-btn" id="default-status-filter">По умолчанию</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </th>
                                    <th >
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Сумма к выводу</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'amount' %}
                                                    <button type="button" class="clear-sort-btn" data-field="amount" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="amount" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'amount')|list %}
                                                            {% set amount_field = sort_fields|selectattr('field', 'equalto', 'amount')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if amount_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Действия</span>
                                            </div>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                    {% if referals or (current_filters and (current_filters.name or current_filters.phone or current_filters.status or current_filters.user)) %}
                            <tbody>
                                {% if referals %}
                                    {% for referal in referals %}
                                    <tr>
                                        <td  class="referal-table-td">{{ referal.referal_data.full_name if referal.referal_data else 'Не указано' }}</td>
                                        <td  class="referal-table-td">{{ referal.referal_data.phone_number if referal.referal_data else 'Не указано' }}</td>
                                        <td  class="referal-table-td">{{ referal.referal_data.contract_number if referal.referal_data else 'Не найден' }}</td>
                                        <td  class="referal-table-td">
                                            <span class="user-login-link" data-user-id="{{ referal.user.id if referal.user else '' }}" title="Просмотр информации о пользователе">
                                                {{ referal.user.login if referal.user else 'Не найден' }}
                                            </span>
                                        </td>
                                        <td  class="referal-table-td">{{ referal.contact_id if referal.contact_id else 'Не найден' }}</td>
                                        <td  class="referal-table-td">{{ referal.status_name if referal.status_name else 'Не указан' }}</td>
                                        <td  class="referal-table-td">{{ referal.withdrawal_amount if referal.withdrawal_amount else '0' }}</td>
                                        <td  class="referal-table-td">
                                            <div class="admin-actions">
                                                <button class="table_button open_document_form" data-referal-id="{{ referal.id }}">
                                                    Карточка
                                                </button>
                                                
                                                <!-- Включаем модальное окно для каждого реферала -->
                                                {% include 'modals/document_form_modal.html' %}
                                                
                                                <!-- Включаем модальное окно информации о пользователе -->
                                                {% if referal.user %}
                                                    {% include 'modals/user_info_modal.html' %}
                                                {% endif %}
                                                
                                                <form method="POST" 
                                                      action="{{ url_for('admin.update_withdrawal_stage', referal_id=referal.id) }}" 
                                                      class="status-update-form" data-referal-id="{{ referal.id }}">
                                                    <select id="new_status_{{ referal.id }}" name="withdrawal_stage" class="status-select" required 
                                                            {% if current_user.role == 'manager' and referal.status_id != 200 %}disabled{% endif %}>
                                                        <option value="">Выберите статус</option>
                                                        {% if current_user.role == 'manager' %}
                                                            <!-- Менеджеры могут менять статус на 0, 300, 500 только если текущий статус 300 -->
                                                            {% if referal.status_id == 200 %}
                                                                {% for status in statuses %}
                                                                    {% if status.id in [0, 300, 500] %}
                                                                    <option value="{{ status.id }}" 
                                                                            {{ 'selected' if status.id == referal.status_id else '' }}>
                                                                        {{ status.name }}
                                                                    </option>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            {% else %}
                                                                <!-- Если статус не 300, показываем только текущий статус -->
                                                                <option value="{{ referal.status_id }}" selected disabled>
                                                                    {{ referal.status_name }} (недоступно для изменения)
                                                                </option>
                                                            {% endif %}
                                                        {% elif current_user.role == 'call-center' %}
                                                            <!-- Call-center видят только статусы 10 и 20 -->
                                                            {% for status in statuses %}
                                                                {% if status.id in [20, 500] %}
                                                                <option value="{{ status.id }}" 
                                                                        {{ 'selected' if status.id == referal.status_id else '' }}>
                                                                    {{ status.name }}
                                                                </option>
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% elif current_user.role == 'admin' %}
                                                            <!-- Админы видят все статусы -->
                                                            {% for status in statuses %}
                                                            <option value="{{ status.id }}" 
                                                                    {{ 'selected' if status.id == referal.status_id else '' }}>
                                                                {{ status.name }}
                                                            </option>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </select>
                                                    <button type="button" class="update-status-btn" title="Обновить статус"
                                                    {% if (current_user.role == 'manager' and referal.status_id != 200) or (current_user.role == 'call-center' and referal.status_id != 10) %}disabled{% endif %}>
                                                        <i class="fas fa-sync-alt"></i>
                                                        {% if current_user.role == 'manager' and referal.status_id != 200 %}
                                                            Недоступно
                                                        {% elif current_user.role == 'call-center' and referal.status_id != 10 %}
                                                            Недоступно
                                                        {% elif current_user.role == 'admin' %}
                                                            Обновить
                                                        {% endif %}
                                                    </button>
                                                </form>
                                                {% include 'modals/rejection_reason_modal.html' %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr class="empty-state-row">
                                        <td colspan="8" class="empty-state-cell">
                                            <div class="empty-state">
                                                <div class="empty-icon">
                                                    <i class="fas fa-clipboard-list"></i>
                                                </div>
                                                <h4>Нет заявок на модерацию</h4>
                                                <p>Все рефералы обработаны</p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                    {% endif %}
                        </table>
                    </div>
                    
                    <!-- Пагинация под таблицей -->
                    {% set base_pagination_url = url_for('admin.admin_panel') %}
                    {% include 'components/pagination.html' %}

                </div>
            </div>
        </main>
        
        {% include 'components/footer.html' %}
    </div>
    
    <!-- Подключение JavaScript файлов -->
    <script src="{{ url_for('static', filename='js/theme-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/table-filters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation/phone-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/flash-messages.js') }}"></script>    <!-- Подключение JavaScript файлов -->        <script src="{{ url_for('static', filename='js/validation/pinfl-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/macro-transfer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/modal-handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/user-modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation/bank-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation/card-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation/passport-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation/email-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/date-picker.js')}}"></script>

        <script>
    particlesJS('particles-js', {
        "particles": { "number": { "value": 50, "density": { "enable": true, "value_area": 800 } }, "color": { "value": "#c4a668" }, "shape": { "type": "polygon", "stroke": { "width": 1, "color": "#c4a668" }, "polygon": { "nb_sides": 6 } }, "opacity": { "value": 0.2, "random": true, "anim": { "enable": true, "speed": 0.5, "opacity_min": 0.05, "sync": false } }, "size": { "value": 4, "random": true }, "line_linked": { "enable": true, "distance": 180, "color": "#c4a668", "opacity": 0.15, "width": 1 }, "move": { "enable": true, "speed": 0.8, "direction": "none", "random": true, "straight": false, "out_mode": "out" } }, "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "bubble" } }, "modes": { "bubble": { "distance": 200, "size": 6, "duration": 2, "opacity": 0.6 } } }, "retina_detect": true
    });
    </script>
    {% include 'components/modal_scripts.html' %}

    <!-- Автоматическая установка фильтра по умолчанию -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusFilter = document.querySelector('.header-filter[data-filter="status"]');
        
        // Убираем весь код автоматической установки фильтров по умолчанию
        // Теперь это делается на серверной стороне только при первом заходе
        
        // Сохраняем выбранный статус при изменении фильтра
        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                // Сохраняем текущий выбор в localStorage
                localStorage.setItem('admin_last_status_filter', this.value);
            });
        }
        
        // Сохраняем статус при отправке формы изменения статуса
        const statusForms = document.querySelectorAll('.status-update-form');
        statusForms.forEach(form => {
            form.addEventListener('submit', function() {
                // Сохраняем текущий статус фильтра перед отправкой формы
                if (statusFilter) {
                    localStorage.setItem('admin_last_status_filter', statusFilter.value);
                }
                
                // Добавляем скрытое поле с текущими фильтрами для сохранения состояния
                const currentUrl = new URL(window.location);
                const params = new URLSearchParams(currentUrl.search);
                
                // Создаем скрытые поля для всех текущих параметров URL
                ['status', 'name', 'phone', 'contract', 'user', 'contact_id', 'page', 'per_page', 'sort'].forEach(param => {
                    const value = params.get(param);
                    if (value) {
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'return_' + param;
                        hiddenInput.value = value;
                        this.appendChild(hiddenInput);
                    }
                });
            });
        });
        
        // Обработчик для кнопки очистки фильтра статуса с роль-специфичной логикой
        const clearStatusFilterBtn = document.querySelector('.clear-filter-btn[data-filter="status"]');
        if (clearStatusFilterBtn) {
            clearStatusFilterBtn.addEventListener('click', function() {
                localStorage.removeItem('admin_last_status_filter');
                // Формируем новый URL вручную, чтобы избежать любых редиректов на /referal/
                let base = window.location.origin + '/referal/admin';
                let params = [];

                // Роль-специфичная логика очистки фильтра
                {% if current_user.role == 'admin' %}
                    params.push('status=-1');
                {% elif current_user.role == 'manager' %}
                    params.push('status=all_manager');
                {% endif %}

                // Сохраняем остальные фильтры кроме status
                const currentParams = new URLSearchParams(window.location.search);
                ['name', 'phone', 'contract', 'user', 'contact_id', 'page', 'per_page', 'sort'].forEach(param => {
                    if (currentParams.has(param)) {
                        params.push(param + '=' + encodeURIComponent(currentParams.get(param)));
                    }
                });

                // Собираем итоговый URL
                let finalUrl = base;
                if (params.length > 0) {
                    finalUrl += '?' + params.join('&');
                }
                window.location.replace(finalUrl);
            });
        }

        // Фикс для применения любого фильтра: всегда отправлять форму на /referal/admin
        document.querySelectorAll('.header-filter').forEach(function(input) {
            input.addEventListener('change', function(e) {
                // Найти форму (или собрать параметры вручную)
                let base = window.location.origin + '/referal/admin';
                let params = [];

                // Собираем все значения фильтров
                document.querySelectorAll('.header-filter').forEach(function(f) {
                    if (f.value && f.getAttribute('data-filter')) {
                        params.push(f.getAttribute('data-filter') + '=' + encodeURIComponent(f.value));
                    }
                });

                // Сохраняем сортировку, если есть
                const currentParams = new URLSearchParams(window.location.search);
                ['sort', 'page', 'per_page'].forEach(param => {
                    if (currentParams.has(param)) {
                        params.push(param + '=' + encodeURIComponent(currentParams.get(param)));
                    }
                });

                let finalUrl = base;
                if (params.length > 0) {
                    finalUrl += '?' + params.join('&');
                }
                window.location.replace(finalUrl);
            });
        });
    });

    
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('status-filter-container');
    if (!container) return;

    const btn = document.getElementById('status-filter-btn');
    const dropdown = document.getElementById('status-filter-dropdown');
    const applyBtn = document.getElementById('apply-status-filter');
    const clearBtn = document.getElementById('clear-status-filter');
    const defaultBtn = document.getElementById('default-status-filter');
    const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
    const all_btn = document.getElementById('all_btn');
    const clear_btn = document.getElementById('clear_btn');

    all_btn.addEventListener('click', (e) => {
      // e.target — это элемент, по которому кликнули (в нашем случае all_checkbox)
      // e.target.checked — это его состояние (true, если выбран, false — если нет)
      // Перебираем все чекбоксы в списке checkboxes
      checkboxes.forEach(checkbox => {
        // Каждому чекбоксу присваиваем то же состояние, что и у главного
        checkbox.checked = true;
      });
    });

    clear_btn.addEventListener('click', (e) => {
      // e.target — это элемент, по которому кликнули (в нашем случае all_checkbox)
      // e.target.checked — это его состояние (true, если выбран, false — если нет)
      // Перебираем все чекбоксы в списке checkboxes
      checkboxes.forEach(checkbox => {
        // Каждому чекбоксу присваиваем то же состояние, что и у главного
        checkbox.checked = false;
      });
    });
    // Функция для обновления текста на кнопке
    const updateButtonText = () => {
        const checkedCount = dropdown.querySelectorAll('input[type="checkbox"]:checked').length;
        const btnText = btn.querySelector('span');
        if (checkedCount > 0) {
            btnText.textContent = `выбрано ${checkedCount}`;
        } else {
            btnText.textContent = 'Статусы';
        }
    };

    // Открытие/закрытие выпадающего списка
    btn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('active');
    });

    // Закрытие по клику вне элемента
    document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
            dropdown.classList.remove('active');
        }
    });
    
    // Не закрывать меню при клике внутри него
    dropdown.addEventListener('click', (e) => e.stopPropagation());

    // Кнопка "Применить"
    applyBtn.addEventListener('click', () => {
        const selectedStatuses = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        const currentUrl = new URL(window.location);
        const params = currentUrl.searchParams;

        if (selectedStatuses.length > 0) {
            params.set('status', selectedStatuses.join(','));
        } else {
            params.delete('status'); // Если ничего не выбрано, убираем параметр
        }
        
        params.set('page', '1'); // Сбрасываем на первую страницу при смене фильтра
        window.location.search = params.toString();
    });
    
    // Кнопка "Все доступные" (сбрасывает URL к состоянию по умолчанию)
    defaultBtn.addEventListener('click', () => {
        const currentUrl = new URL(window.location);
        const params = currentUrl.searchParams;
        
        // Эта кнопка приводит фильтр статусов в стандартное значение, удаляя параметр 'status'
        params.delete('status');
        params.set('page', '1');
        
        window.location.search = params.toString();
    });
    
    // Инициализация текста кнопки при загрузке страницы
    updateButtonText();
});
    </script>

    <script src="{{ url_for('static', filename='js/components/rejection_reason_opener.js') }}"></script>
</script>

</body>
</html>