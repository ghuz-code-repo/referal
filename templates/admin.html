<!-- filepath: c:\Users\d.tolkunov\CodeRepository\AnalyticsRepo\referal\templates\admin.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление рефералами</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Подключение CSS файлов -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/tables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/modals.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/cards.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/inputs.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/notifications.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/responsive.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/footer.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/filters.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/pagination.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/table-filters.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/validation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/macro-crm.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/add-referal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/referals.css') }}">
    
</head>
<body>
    <div class="page-wrapper">
        {% include 'components/header.html' %}
        {% include 'components/flash_messages.html' %}
        
        <main class="main">
            <div class="container">
                <div class="admin-section">
                    <div class="section-header">
                        <div class="section-title">
                            {% if current_user.role == 'manager' %}
                            <h3><i class="fas fa-money-check-alt"></i> Управление выплатами</h3>
                            <p class="section-subtitle">Рефералы готовые к выплате</p>
                            {% else %}
                            <h3><i class="fas fa-users-cog"></i> Управление рефералами</h3>
                            <p class="section-subtitle">Все рефералы в системе для модерации</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>ФИО</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'name' %}
                                                    <button type="button" class="clear-sort-btn" data-field="name" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="name" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'name')|list %}
                                                            {% set name_field = sort_fields|selectattr('field', 'equalto', 'name')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if name_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="header-controls">
                                                <input type="text" 
                                                       class="header-filter" 
                                                       placeholder="Поиск по ФИО"
                                                       value="{{ current_filters.name if current_filters else '' }}"
                                                       data-filter="name">
                                                {% if current_filters and current_filters.name %}
                                                <button type="button" class="clear-filter-btn" data-filter="name" title="Очистить фильтр">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </th>
                                    <th style="width: 12%;">
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Телефон</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'phone' %}
                                                    <button type="button" class="clear-sort-btn" data-field="phone" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="phone" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'phone')|list %}
                                                            {% set phone_field = sort_fields|selectattr('field', 'equalto', 'phone')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if phone_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="header-controls">
                                                <input type="text" 
                                                       class="header-filter" 
                                                       placeholder="Поиск по телефону"
                                                       value="{{ current_filters.phone if current_filters else '' }}"
                                                       data-filter="phone">
                                                {% if current_filters and current_filters.phone %}
                                                <button type="button" class="clear-filter-btn" data-filter="phone" title="Очистить фильтр">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </th>
                                    <th style="width: 12%;">
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Договор</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'contract' %}
                                                    <button type="button" class="clear-sort-btn" data-field="contract" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="contract" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'contract')|list %}
                                                            {% set contract_field = sort_fields|selectattr('field', 'equalto', 'contract')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if contract_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="header-controls">
                                                <input type="text" 
                                                       class="header-filter" 
                                                       placeholder="Номер договора"
                                                       value="{{ current_filters.contract if current_filters else '' }}"
                                                       data-filter="contract">
                                                {% if current_filters and current_filters.contract %}
                                                <button type="button" class="clear-filter-btn" data-filter="contract" title="Очистить фильтр">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </th>
                                    <th style="width: 10%;">
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Пользователь</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'user' %}
                                                    <button type="button" class="clear-sort-btn" data-field="user" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="user" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'user')|list %}
                                                            {% set user_field = sort_fields|selectattr('field', 'equalto', 'user')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if user_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="header-controls">
                                                <input type="text" 
                                                       class="header-filter" 
                                                       placeholder="Пользователь"
                                                       value="{{ current_filters.user if current_filters else '' }}"
                                                       data-filter="user">
                                                {% if current_filters and current_filters.user %}
                                                <button type="button" class="clear-filter-btn" data-filter="user" title="Очистить фильтр">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </th>
                                    <th style="width: 8%;">
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Macro ID</span>
                                            </div>
                                            <div class="header-controls">
                                                <input type="text" 
                                                       class="header-filter" 
                                                       placeholder="Macro ID"
                                                       value="{{ current_filters.contact_id if current_filters else '' }}"
                                                       data-filter="contact_id">
                                                {% if current_filters and current_filters.contact_id %}
                                                <button type="button" class="clear-filter-btn" data-filter="contact_id" title="Очистить фильтр">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </th>
                                    <th style="width: 10%;">
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Статус</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'status' %}
                                                    <button type="button" class="clear-sort-btn" data-field="status" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="status" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'status')|list %}
                                                            {% set status_field = sort_fields|selectattr('field', 'equalto', 'status')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if status_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="header-controls">
                                                <select class="header-filter header-select" data-filter="status">
                                                    {% if current_user.role == 'manager' %}
                                                        <!-- Менеджеры видят только статусы для просмотра -->
                                                        {% for status in statuses %}
                                                            {% if status.id in [200, 300, 500] %}
                                                            <option value="{{ status.id }}" {{ 'selected' if current_filters.status == status.id|string else ('selected' if status.id == 200 and not current_filters.status else '') }}>
                                                                {{ status.name }}
                                                            </option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <!-- Админы видят все статусы с опцией "Все" -->
                                                        <option value="-1">Все</option>
                                                        {% for status in statuses %}
                                                        <option value="{{ status.id }}" {{ 'selected' if current_filters.status == status.id|string else ('selected' if status.id == 1 and not current_filters.status else '') }}>
                                                            {{ status.name }}
                                                        </option>
                                                        {% endfor %}
                                                    {% endif %}
                                                </select>
                                                {% if current_filters and current_filters.status %}
                                                <button type="button" class="clear-filter-btn" data-filter="status" title="Очистить фильтр">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </th>
                                    <th style="width: 10%;">
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Сумма к выводу</span>
                                                <div class="sort-controls">
                                                    {% for sort_field in sort_fields %}
                                                        {% if sort_field.field == 'amount' %}
                                                    <button type="button" class="clear-sort-btn" data-field="amount" title="Убрать из сортировки">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <span class="sort-number">{{ loop.index }}</span>
                                                        {% endif %}
                                                    {% endfor %}
                                                    
                                                    <button type="button" class="sort-btn" data-field="amount" title="Изменить сортировку">
                                                        {% if sort_fields|selectattr('field', 'equalto', 'amount')|list %}
                                                            {% set amount_field = sort_fields|selectattr('field', 'equalto', 'amount')|first %}
                                                            <i class="fas fa-caret-{{ 'up' if amount_field.order == 'asc' else 'down' }}"></i>
                                                        {% else %}
                                                            <i class="fas fa-sort"></i>
                                                        {% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </th>
                                    <th style="width: 23%;">
                                        <div class="header-cell">
                                            <div class="header-title">
                                                <span>Действия</span>
                                            </div>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                    {% if referals or (current_filters and (current_filters.name or current_filters.phone or current_filters.status or current_filters.user)) %}
                            <tbody>
                                {% if referals %}
                                    {% for referal in referals %}
                                    <tr>
                                        <td style="width: 15%;">{{ referal.referal_data.full_name if referal.referal_data else 'Не указано' }}</td>
                                        <td style="width: 12%;">{{ referal.referal_data.phone_number if referal.referal_data else 'Не указано' }}</td>
                                        <td style="width: 12%;">{{ referal.referal_data.contract_number if referal.referal_data else 'Не найден' }}</td>
                                        <td style="width: 10%;">
                                            <span class="user-login-link" data-user-id="{{ referal.user.id if referal.user else '' }}" title="Просмотр информации о пользователе">
                                                {{ referal.user.login if referal.user else 'Не найден' }}
                                            </span>
                                        </td>
                                        <td style="width: 8%;">{{ referal.contact_id if referal.contact_id else 'Не найден' }}</td>
                                        <td style="width: 10%;">{{ referal.status_name if referal.status_name else 'Не указан' }}</td>
                                        <td style="width: 10%;">{{ referal.withdrawal_amount if referal.withdrawal_amount else '0' }}</td>
                                        <td style="width: 23%;">
                                            <div class="admin-actions">
                                                <button class="table_button open_document_form" data-referal-id="{{ referal.id }}">
                                                    Карточка
                                                </button>
                                                
                                                <!-- Включаем модальное окно для каждого реферала -->
                                                {% include 'modals/document_form_modal.html' %}
                                                
                                                <!-- Включаем модальное окно информации о пользователе -->
                                                {% if referal.user %}
                                                    {% include 'modals/user_info_modal.html' %}
                                                {% endif %}
                                                
                                                <form method="POST" 
                                                      action="{{ url_for('admin.update_withdrawal_stage', referal_id=referal.id) }}" 
                                                      class="status-update-form">
                                                    <select name="withdrawal_stage" class="status-select" required 
                                                            {% if current_user.role == 'manager' and referal.status_id != 200 %}disabled{% endif %}>
                                                        <option value="">Выберите статус</option>
                                                        {% if current_user.role == 'manager' %}
                                                            <!-- Менеджеры могут менять статус на 0, 300, 500 только если текущий статус 300 -->
                                                            {% if referal.status_id == 200 %}
                                                                {% for status in statuses %}
                                                                    {% if status.id in [0, 300, 500] %}
                                                                    <option value="{{ status.id }}" 
                                                                            {{ 'selected' if status.id == referal.status_id else '' }}>
                                                                        {{ status.name }}
                                                                    </option>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            {% else %}
                                                                <!-- Если статус не 300, показываем только текущий статус -->
                                                                <option value="{{ referal.status_id }}" selected disabled>
                                                                    {{ referal.status_name }} (недоступно для изменения)
                                                                </option>
                                                            {% endif %}
                                                        {% else %}
                                                            <!-- Админы видят все статусы -->
                                                            {% for status in statuses %}
                                                            <option value="{{ status.id }}" 
                                                                    {{ 'selected' if status.id == referal.status_id else '' }}>
                                                                {{ status.name }}
                                                            </option>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </select>
                                                    <button type="submit" class="update-status-btn" title="Обновить статус"
                                                            {% if current_user.role == 'manager' and referal.status_id != 200 %}disabled{% endif %}>
                                                        <i class="fas fa-sync-alt"></i>
                                                        {% if current_user.role == 'manager' and referal.status_id != 200 %}
                                                            Недоступно
                                                        {% else %}
                                                            Обновить
                                                        {% endif %}
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr class="empty-state-row">
                                        <td colspan="8" class="empty-state-cell">
                                            <div class="empty-state">
                                                <div class="empty-icon">
                                                    <i class="fas fa-clipboard-list"></i>
                                                </div>
                                                <h4>Нет заявок на модерацию</h4>
                                                <p>Все рефералы обработаны</p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                    {% endif %}
                        </table>
                    </div>
                    
                    <!-- Пагинация под таблицей -->
                    {% set base_pagination_url = url_for('admin.admin_panel') %}
                    {% include 'components/pagination.html' %}

                </div>
            </div>
        </main>
        
        {% include 'components/footer.html' %}
    </div>
    <script src="{{ url_for('static', filename='js/components/table-filters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation/phone-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/flash-messages.js') }}"></script>    <!-- Подключение JavaScript файлов -->        <script src="{{ url_for('static', filename='js/validation/pinfl-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/macro-transfer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/modal-handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/components/user-modal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation/bank-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation/card-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation/passport-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation/email-validation.js') }}"></script>

    {% include 'components/modal_scripts.html' %}    <!-- Включаем компонент с модальными окнами -->        

    <!-- Автоматическая установка фильтра по умолчанию -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusFilter = document.querySelector('.header-filter[data-filter="status"]');
        const urlParams = new URLSearchParams(window.location.search);
        
        // Проверяем, есть ли сохраненный статус в localStorage
        const savedStatus = localStorage.getItem('admin_last_status_filter');
        
        // Проверяем, есть ли уже параметр status в URL
        if (statusFilter && !urlParams.has('status')) {
            if (savedStatus) {
                // Используем сохраненный статус
                statusFilter.value = savedStatus;
            } else {
                // Используем значения по умолчанию
                {% if current_user.role == 'manager' %}
                    // Для менеджеров устанавливаем статус 200
                    statusFilter.value = '200';
                {% else %}
                    // Для админов устанавливаем статус 1
                    statusFilter.value = '1';
                {% endif %}
            }
            
            // Автоматически применяем фильтр
            statusFilter.dispatchEvent(new Event('change'));
        }
        
        // Сохраняем выбранный статус при изменении фильтра
        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                // Сохраняем текущий выбор в localStorage
                localStorage.setItem('admin_last_status_filter', this.value);
            });
        }
        
        // Сохраняем статус при отправке формы изменения статуса
        const statusForms = document.querySelectorAll('.status-update-form');
        statusForms.forEach(form => {
            form.addEventListener('submit', function() {
                // Сохраняем текущий статус фильтра перед отправкой формы
                if (statusFilter) {
                    localStorage.setItem('admin_last_status_filter', statusFilter.value);
                }
            });
        });
        
        // Обработчик для кнопки очистки фильтра статуса
        const clearStatusFilterBtn = document.querySelector('.clear-filter-btn[data-filter="status"]');
        if (clearStatusFilterBtn) {
            clearStatusFilterBtn.addEventListener('click', function() {
                // Очищаем сохраненный статус из localStorage
                localStorage.removeItem('admin_last_status_filter');
            });
        }
    });
    </script>

</body>
</html>